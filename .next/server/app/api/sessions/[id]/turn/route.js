"use strict";(()=>{var e={};e.id=300,e.ids=[300],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},93977:e=>{e.exports=require("node:fs/promises")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},59558:(e,t,s)=>{s.r(t),s.d(t,{headerHooks:()=>x,originalPathname:()=>K,patchFetch:()=>C,requestAsyncStorage:()=>S,routeModule:()=>A,serverHooks:()=>b,staticGenerationAsyncStorage:()=>P,staticGenerationBailout:()=>k});var r={};s.r(r),s.d(r,{POST:()=>I});var n=s(95419),a=s(69108),o=s(99678),i=s(78070),c=s(81355),l=s(82002),u=s(19631);class p{constructor(e){this.apiKey=e}async transcribeAudio(e,t){let s=new FormData,r=new Blob([e],{type:t});s.append("file",r,"audio.webm"),s.append("model","whisper-1");let n=await fetch("https://api.openai.com/v1/audio/transcriptions",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`},body:s});if(!n.ok)throw Error(`OpenAI STT failed: ${n.statusText}`);return(await n.json()).text}}class d{constructor(e){this.apiKey=e}async transcribeAudio(e,t){let s=await fetch("https://api.deepgram.com/v1/listen",{method:"POST",headers:{Authorization:`Token ${this.apiKey}`,"Content-Type":t},body:e});if(!s.ok)throw Error(`Deepgram STT failed: ${s.statusText}`);let r=await s.json();return r.results?.channels[0]?.alternatives[0]?.transcript||""}}class h{async transcribeAudio(e,t){return console.log("[Mock STT] Transcribing audio of size:",e.length),"This is a mock transcription. Configure STT_PROVIDER and API keys to use real transcription."}}let m=function(){switch(process.env.STT_PROVIDER||"mock"){case"openai":if(!process.env.OPENAI_API_KEY)return console.warn("OPENAI_API_KEY not set, falling back to mock STT"),new h;return new p(process.env.OPENAI_API_KEY);case"deepgram":if(!process.env.DEEPGRAM_API_KEY)return console.warn("DEEPGRAM_API_KEY not set, falling back to mock STT"),new h;return new d(process.env.DEEPGRAM_API_KEY);default:return new h}}();var f=s(17e3),g=s(33235);class y{checkContent(e){let t=e.toLowerCase();for(let s of this.selfHarmPatterns)if(s.test(t))return{isSafe:!1,category:t.includes("suicid")?"suicide":"self_harm",snippet:e.substring(0,200),crisisResponse:this.getCrisisResponse()};return{isSafe:!0}}getCrisisResponse(){return`I'm concerned about what you've shared. Your safety is important, and I want to make sure you get the support you need right now.

If you're in the United States, please reach out to the 988 Suicide and Crisis Lifeline by calling or texting 988. They provide free, confidential support 24/7.

If you're outside the US, please contact your local emergency services or crisis helpline.

You can also:
- Reach out to a trusted friend, family member, or mental health professional
- Go to your nearest emergency room if you're in immediate danger

Remember, you don't have to face this alone. There are people who want to help and support you through this difficult time.

I'm here to listen, but I'm not equipped to provide crisis support. Please reach out to a trained professional who can help you right now.`}constructor(){this.selfHarmPatterns=[/\b(kill|hurt|harm|cut|end)\s+(myself|my\s*self)\b/i,/\bsuicid(e|al)\b/i,/\bwant\s+to\s+die\b/i,/\bno\s+reason\s+to\s+live\b/i,/\bdon'?t\s+want\s+to\s+be\s+here\b/i,/\bend\s+it\s+all\b/i,/\bbetter\s+off\s+dead\b/i]}}let w=new y;var T=s(76942),E=s(92373),_=s(72245);let v=parseInt(process.env.MAX_SESSION_TURNS||"100",10);async function I(e,{params:t}){try{let s=await (0,c.getServerSession)(l.L);if(!s?.user?.id)return i.Z.json({error:"Unauthorized"},{status:401});let r=(await e.formData()).get("audio");if(!r)return i.Z.json({error:"Audio file required"},{status:400});let n=await u._.session.findFirst({where:{id:t.id,userId:s.user.id,deletedAt:null},include:{persona:{include:{media:{where:{mediaType:"voice_reference"}}}},messages:{orderBy:{createdAt:"asc"},take:50}}});if(!n)return i.Z.json({error:"Session not found"},{status:404});if(n.messages.length>=2*v)return i.Z.json({error:"Session turn limit reached"},{status:429});let a=n.persona.media[0];if(!a)return i.Z.json({error:"Persona missing voice reference"},{status:400});let o=Buffer.from(await r.arrayBuffer()),p=await m.transcribeAudio(o,r.type),d=w.checkContent(p);if(!d.isSafe)return await u._.safetyEvent.create({data:{sessionId:t.id,userId:s.user.id,category:d.category,snippet:d.snippet}}),await u._.sessionMessage.create({data:{sessionId:t.id,role:"user",text:p}}),i.Z.json({userTranscript:p,assistantTranscript:d.crisisResponse,assistantAudioUrl:null,crisisDetected:!0});await u._.sessionMessage.create({data:{sessionId:t.id,role:"user",text:p}});let h={ageNumber:n.persona.ageNumber,tonePreset:n.toneSnapshot,customToneText:n.persona.customToneText||void 0,contextPrompt:n.contextSnapshot},y=n.messages.map(e=>({role:e.role,text:e.text}));y.push({role:"user",text:p});let I=T.d.buildConversationMessages(h,y),A=await f.d.generateResponse(I);w.checkContent(A).isSafe||console.warn("[Turn] Assistant response triggered safety check:",A),await u._.sessionMessage.create({data:{sessionId:t.id,role:"assistant",text:A}});let S=await g.K.synthesizeVoice(A,a.storageKey),P=(0,_.sO)(s.user.id,"assistant-audio",`turn-${Date.now()}.wav`);await E.H.uploadFile(P,S,"audio/wav"),await u._.sessionArtifact.create({data:{sessionId:t.id,artifactType:"assistant_audio",storageKey:P,mimeType:"audio/wav"}});let b=await E.H.getSignedDownloadUrl(P);return i.Z.json({userTranscript:p,assistantTranscript:A,assistantAudioUrl:b,crisisDetected:!1})}catch(e){return console.error("[Turn] Processing error:",e),i.Z.json({error:"Failed to process turn",details:e.message},{status:500})}}let A=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/sessions/[id]/turn/route",pathname:"/api/sessions/[id]/turn",filename:"route",bundlePath:"app/api/sessions/[id]/turn/route"},resolvedPagePath:"C:\\Users\\mrted\\talk-to-your-inner-self\\src\\app\\api\\sessions\\[id]\\turn\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:S,staticGenerationAsyncStorage:P,serverHooks:b,headerHooks:x,staticGenerationBailout:k}=A,K="/api/sessions/[id]/turn/route";function C(){return(0,o.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:P})}},82002:(e,t,s)=>{s.d(t,{L:()=>i});var r=s(86485),n=s(6521),a=s.n(n),o=s(19631);let i={providers:[(0,r.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)throw Error("Missing credentials");let t=await o._.user.findUnique({where:{email:e.email}});if(!t||t.deletedAt||!await a().compare(e.password,t.password))throw Error("Invalid credentials");return{id:t.id,email:t.email}}})],session:{strategy:"jwt",maxAge:2592e3},pages:{signIn:"/auth/signin"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id),e)},secret:process.env.NEXTAUTH_SECRET}},19631:(e,t,s)=>{s.d(t,{_:()=>n});let r=require("@prisma/client"),n=globalThis.prisma??new r.PrismaClient({log:["error"]})},72245:(e,t,s)=>{s.d(t,{sO:()=>r});function r(e,t,s){let r=Date.now(),n=Math.random().toString(36).substring(7),a=s.replace(/[^a-zA-Z0-9.-]/g,"_");return`${t}/${e}/${r}-${n}-${a}`}},17e3:(e,t,s)=>{s.d(t,{d:()=>o});class r{constructor(e){this.apiKey=e}async generateResponse(e){let t=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-4-turbo-preview",messages:e,temperature:.7,max_tokens:300})});if(!t.ok)throw Error(`OpenAI LLM failed: ${t.statusText}`);let s=await t.json();return s.choices[0]?.message?.content||""}}class n{constructor(e){this.apiKey=e}async generateResponse(e){let t=e.find(e=>"system"===e.role),s=e.filter(e=>"system"!==e.role),r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"x-api-key":this.apiKey,"anthropic-version":"2023-06-01","Content-Type":"application/json"},body:JSON.stringify({model:"claude-3-opus-20240229",max_tokens:300,system:t?.content||"",messages:s.map(e=>({role:"assistant"===e.role?"assistant":"user",content:e.content}))})});if(!r.ok)throw Error(`Anthropic LLM failed: ${r.statusText}`);let n=await r.json();return n.content[0]?.text||""}}class a{async generateResponse(e){console.log("[Mock LLM] Generating response for",e.length,"messages");let t=e.filter(e=>"user"===e.role).pop()?.content||"";return`I hear you saying: "${t.substring(0,50)}...". This is a mock response. Configure LLM_PROVIDER and API keys to use real AI responses.`}}let o=function(){switch(process.env.LLM_PROVIDER||"mock"){case"openai":if(!process.env.OPENAI_API_KEY)return console.warn("OPENAI_API_KEY not set, falling back to mock LLM"),new a;return new r(process.env.OPENAI_API_KEY);case"anthropic":if(!process.env.ANTHROPIC_API_KEY)return console.warn("ANTHROPIC_API_KEY not set, falling back to mock LLM"),new a;return new n(process.env.ANTHROPIC_API_KEY);default:return new a}}()},76942:(e,t,s)=>{s.d(t,{d:()=>n});class r{getSystemPrompt(e){let t=this.getToneInstruction(e.tonePreset,e.customToneText);return`You are engaged in a reflective conversation with someone who is imagining themselves at age ${e.ageNumber}.

Context about this person at age ${e.ageNumber}:
${e.contextPrompt}

${t}

Important boundaries:
- You are NOT a therapist, counselor, or medical professional
- Do not provide medical, diagnostic, or clinical advice
- Do not tell the person what to do or pressure them to continue talking
- Do not suggest starting or stopping medications
- Be reflective and supportive, not directive or authoritative
- Keep responses natural and conversational (2-4 sentences typically)
- Do not assume trauma or negative experiences unless the person shares them
- If the person expresses thoughts of self-harm or suicide, IMMEDIATELY stop the roleplay and provide crisis resources

Your role is to be a supportive, reflective presence that helps the person explore their thoughts and feelings about this time in their life.`}getInitiationPrompt(e){return[{role:"system",content:this.getSystemPrompt(e)},{role:"user",content:"Please greet me and invite me to share. Keep it brief and warm. Do not assume I have problems or trauma."}]}buildConversationMessages(e,t){let s=[{role:"system",content:this.getSystemPrompt(e)}];for(let e of t)s.push({role:e.role,content:e.text});return s}getToneInstruction(e,t){if("custom"===e&&t)return`Tone and style: ${t}`;switch(e){case"gentle":return"Tone: Gentle and nurturing. Speak with warmth, compassion, and softness. Use language that feels caring and safe. Express understanding and validation.";case"neutral":return"Tone: Neutral and observational. Be present and attentive without adding emotional coloring. Reflect what you hear with clarity and minimal interpretation.";case"playful":return"Tone: Playful and lighthearted. Bring a sense of ease, curiosity, and gentle humor when appropriate. Keep things feeling light while still being genuine.";default:return"Tone: Balanced and supportive. Be warm and present, adapting your tone to match what the person shares."}}}let n=new r},92373:(e,t,s)=>{s.d(t,{H:()=>m});let r=require("@aws-sdk/client-s3");var n=s(54363);let a={region:process.env.AWS_REGION||"us-east-1",credentials:{accessKeyId:process.env.AWS_ACCESS_KEY_ID||"",secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY||""},...process.env.AWS_S3_ENDPOINT&&{endpoint:process.env.AWS_S3_ENDPOINT}},o=new r.S3Client(a),i=process.env.AWS_S3_BUCKET||"inner-self-media",c=parseInt(process.env.SIGNED_URL_EXPIRY_SECONDS||"3600",10);async function l(e,t){let s=new r.PutObjectCommand({Bucket:i,Key:e,ContentType:t});return(0,n.e)(o,s,{expiresIn:c})}async function u(e){let t=new r.GetObjectCommand({Bucket:i,Key:e});return(0,n.e)(o,t,{expiresIn:c})}async function p(e){let t=new r.DeleteObjectCommand({Bucket:i,Key:e});await o.send(t)}async function d(e,t,s){let n=new r.PutObjectCommand({Bucket:i,Key:e,Body:t,ContentType:s});await o.send(n)}class h{async getSignedUploadUrl(e,t){return l(e,t)}async getSignedDownloadUrl(e){return u(e)}async uploadFile(e,t,s){return d(e,t,s)}async deleteFile(e){try{await p(e),console.log(`[Storage] Deleted: ${e}`)}catch(t){console.error(`[Storage] Failed to delete ${e}:`,t)}}async deleteFiles(e){let t=(await Promise.allSettled(e.map(e=>this.deleteFile(e)))).filter(e=>"rejected"===e.status);t.length>0&&console.warn(`[Storage] Failed to delete ${t.length} of ${e.length} files`)}}let m=new h},33235:(e,t,s)=>{s.d(t,{K:()=>i});class r{constructor(e){this.apiKey=e}async synthesizeVoice(e,t){let s=process.env.ELEVENLABS_VOICE_ID||"default",r=await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${s}`,{method:"POST",headers:{"xi-api-key":this.apiKey,"Content-Type":"application/json"},body:JSON.stringify({text:e,model_id:"eleven_monolingual_v1",voice_settings:{stability:.5,similarity_boost:.5}})});if(!r.ok)throw Error(`ElevenLabs TTS failed: ${r.statusText}`);let n=await r.arrayBuffer();return Buffer.from(n)}}class n{constructor(e){this.apiKey=e}async synthesizeVoice(e,t){let s=await fetch("https://api.cartesia.ai/tts/bytes",{method:"POST",headers:{"Cartesia-Version":"2024-06-10","X-API-Key":this.apiKey,"Content-Type":"application/json"},body:JSON.stringify({model_id:"sonic-english",transcript:e,voice:{mode:"id",id:"default"},output_format:{container:"wav",encoding:"pcm_f32le",sample_rate:44100}})});if(!s.ok)throw Error(`Cartesia TTS failed: ${s.statusText}`);let r=await s.arrayBuffer();return Buffer.from(r)}}class a{constructor(e,t){this.apiKey=e,this.userId=t}async synthesizeVoice(e,t){let s=await fetch("https://api.play.ht/api/v2/tts",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"X-User-ID":this.userId,"Content-Type":"application/json"},body:JSON.stringify({text:e,voice:"default",output_format:"mp3",speed:1})});if(!s.ok)throw Error(`PlayHT TTS failed: ${s.statusText}`);let r=await s.arrayBuffer();return Buffer.from(r)}}class o{async synthesizeVoice(e,t){console.log("[Mock TTS] Synthesizing:",e.substring(0,50)),console.log("[Mock TTS] Voice reference:",t);let s=Buffer.alloc(88244);return s.write("RIFF",0),s.writeUInt32LE(88236,4),s.write("WAVE",8),s.write("fmt ",12),s.writeUInt32LE(16,16),s.writeUInt16LE(1,20),s.writeUInt16LE(1,22),s.writeUInt32LE(44100,24),s.writeUInt32LE(88200,28),s.writeUInt16LE(2,32),s.writeUInt16LE(16,34),s.write("data",36),s.writeUInt32LE(88200,40),s.fill(0,44),s}}let i=function(){switch(process.env.TTS_PROVIDER||"mock"){case"elevenlabs":if(!process.env.ELEVENLABS_API_KEY)return console.warn("ELEVENLABS_API_KEY not set, falling back to mock TTS"),new o;return new r(process.env.ELEVENLABS_API_KEY);case"cartesia":if(!process.env.CARTESIA_API_KEY)return console.warn("CARTESIA_API_KEY not set, falling back to mock TTS"),new o;return new n(process.env.CARTESIA_API_KEY);case"playht":if(!process.env.PLAYHT_API_KEY||!process.env.PLAYHT_USER_ID)return console.warn("PLAYHT_API_KEY or PLAYHT_USER_ID not set, falling back to mock TTS"),new o;return new a(process.env.PLAYHT_API_KEY,process.env.PLAYHT_USER_ID);default:return new o}}()}};var t=require("../../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[638,914,123,70,363],()=>s(59558));module.exports=r})();